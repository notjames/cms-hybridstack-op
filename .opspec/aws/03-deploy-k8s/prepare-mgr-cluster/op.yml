---
name: aws/03-deploy-gardener/prepare-mgr-cluster
description: prepare cmc master host for gardener bits
inputs:
  USER:
    string:
      description: USER env variable
  GID:
    number:
      description: GID env var
  UID:
    number:
      description: UID env var
  CLUSTER_ID:
    string:
      description: CLUSTER_ID environment variable
      default: "nil"
  HOMEDir:
    dir:
      description: HOME env variable as a directory
  OS_TYPE:
    string:
      description: OS_TYPE environment variable if set.
      default: centos
  private_key:
    string:
      description: "This is a base64 encoded private key. These are not the bits you're looking for"
  cluster_id:
    string:
      constraints: { minLength: 1 }
      description: Name of the cluster
      default: "nil"
  os_type:
    string:
      constraints: { minLength: 1 }
      default: centos
#  githubUsername:
#    string:
#      constraints: { minLength: 1 }
#      description: username for auth
#  githubPassword:
#    string:
#      constraints: { minLength: 1 }
#      description: password for auth (or personal access token)
#      isSecret: true
  aws_default_region:
    string:
      constraints: { minLength: 1 }
      description: default AWS region
      default: us-west-2
  AWS_DEFAULT_REGION:
    string:
      description: default AWS region environment variable if set.
      default: "us-west-2"
  mount_bin_runroot:
    dir:
      description: the bin directory containing scripts used for all AWS op steps.
  mount_deploy_runroot:
    dir:
      description: the mount point path for all things deployment
  context:
    dir:
      description: context for build
      default: .opspec/aws
  dockerfile:
    file:
      description: DinD dockerfile
      default: .opspec/aws/Dockerfile
  dockerSocket:
    socket:
      description: access to docker on node
  dindcontainer:
    string:
      description: "dind runtime container"
      default: "cmc-build:latest"

outputs:
  aws_access_id:
    string:
      description: exported AWS creds access id
  aws_secret_key:
    string:
      description: exported AWS creds access key
  kubeConfig:
    file:
      description: kubeconfig from manager master

run:
  serial:
  - container:
      image: { ref: $(dindcontainer) }
      stdOut:
        AWS_ACCESS_KEY_ID=: aws_access_id
        AWS_SECRET_ACCESS_KEY=: aws_secret_key
      dirs:
        /root/bin: $(mount_bin_runroot)
        /root/.aws: $(HOMEDir/.aws)
      workDir: /root
      sockets:
        /var/run/docker.sock: dockerSocket
      cmd:
        - sh
        - -ce
        - |
          bin/export_aws_creds.sh | tr ' ' '\n'

  - container:
      image: { ref: $(dindcontainer) }
      dirs:
        /root: $(mount_deploy_runroot)
        /root/bin: $(mount_bin_runroot)
        /root/.aws: $(HOMEDir/.aws)
        /root/.ssh: $(HOMEDir/.ssh)
        /root/.kube:
        /var/tmp:
      workDir: /root
      files:
        /cmd.sh:
        /var/tmp/config: $(kubeConfig)
      sockets:
        /var/run/docker.sock: dockerSocket
      envVars:
        AWS_ACCESS_KEY_ID: $(aws_access_id)
        AWS_SECRET_ACCESS_KEY: $(aws_secret_key)
        AWS_DEFAULT_REGION: $(AWS_DEFAULT_REGION)
        _aws_default_region: $(aws_default_region)
        CLUSTER_ID: $(CLUSTER_ID)
        CLUSTER_PRIVATE_KEY: $(private_key)
        _cluster_id: $(cluster_id)
        OS_TYPE: $(OS_TYPE)
        _os_type: $(os_type)
        OWNER_USER: $(USER)
        OWNER_UID: $(UID)
        OWNER_GID: $(GID)
      cmd: [ /cmd.sh ]
